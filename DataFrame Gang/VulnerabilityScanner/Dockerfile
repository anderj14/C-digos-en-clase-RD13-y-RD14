FROM python:3.11-slim

# Establecer el directorio de trabajo
WORKDIR /app

# Instalar Poetry
RUN pip install --no-cache-dir poetry

# Configurar Poetry para NO crear virtualenv (usar sistema)
RUN poetry config virtualenvs.create false

# Copiar archivos de dependencias
COPY pyproject.toml poetry.lock* ./

# --- CORRECCIÓN AQUÍ ---
# Copiar el resto del código ANTES de instalar
COPY . .

# Instalar dependencias y el proyecto en sí
RUN poetry install --no-interaction --no-ansi

# Crear directorio para la base de datos SQLite
RUN mkdir -p /app/data

# Copiar y dar permisos al script de entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expone el puerto que la aplicación usará
EXPOSE 8000

# Usar el script de entrypoint
ENTRYPOINT ["/entrypoint.sh"]
