from fastapi import FastAPI, Depends, Request
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.templating import Jinja2Templates
from fastapi.staticfiles import StaticFiles
from sqlalchemy.orm import Session
from database import models
from database.database import get_db, engine

models.Base.metadata.create_all(bind=engine)

app = FastAPI(title="VulnScanner Dashboard")

app.mount("/static", StaticFiles(directory="dashboard/static"), name="static")
templates = Jinja2Templates(directory="dashboard/templates")

@app.get("/", response_class=HTMLResponse)
def read_root(request: Request, db: Session = Depends(get_db)):
    """
    Ruta principal del dashboard con todos los hallazgos.
    """
    findings = db.query(models.Finding).order_by(models.Finding.timestamp.desc()).all()
    return templates.TemplateResponse("dashboard.html", {
        "request": request,
        "findings": findings
    })

@app.post("/clear-findings", response_class=RedirectResponse)
def clear_findings(db: Session = Depends(get_db)):
    """
    Elimina todos los hallazgos de la base de datos.
    """
    try:
        db.query(models.Finding).delete()
        db.commit()
    except Exception as e:
        db.rollback()
        print(f"Error al borrar los hallazgos: {e}")
    
    return RedirectResponse(url="/", status_code=303)
